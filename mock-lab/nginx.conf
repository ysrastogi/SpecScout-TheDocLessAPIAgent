events {
    worker_connections 1024;
}

http {
    upstream payment-service {
        server payment-service:3001;
    }

    upstream webhook-service {
        server webhook-service:3002;
    }

    upstream oauth2-server {
        server oauth2-server:3003;
    }

    server {
        listen 80;
        server_name localhost;

        # Health check endpoint
        location /health {
            access_log off;
            return 200 '{"status":"healthy","service":"api-gateway","timestamp":"$time_iso8601"}';
            add_header Content-Type application/json;
        }

        # Payment service routes
        location /payments {
            proxy_pass http://payment-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Webhook service routes
        location /webhook {
            proxy_pass http://webhook-service;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # OAuth2 service routes
        location /auth {
            proxy_pass http://oauth2-server;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Default route - API documentation
        location / {
            return 200 '<!DOCTYPE html>
<html>
<head>
    <title>Docless API Demo - Mock Services</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .service { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .endpoint { background: #e8f4fd; padding: 10px; margin: 5px 0; font-family: monospace; }
        h1 { color: #333; } h2 { color: #666; }
    </style>
</head>
<body>
    <h1>üöÄ Docless API Demo - Mock Services</h1>
    <p>This gateway provides access to demonstration services showcasing API patterns.</p>
    
    <div class="service">
        <h2>üí≥ Payment Service (Port 3001)</h2>
        <p>Demonstrates idempotency key patterns</p>
        <div class="endpoint">GET /payments/demo/idempotency - Documentation</div>
        <div class="endpoint">POST /payments - Create payment (requires Idempotency-Key)</div>
        <div class="endpoint">GET /payments/:id - Get payment details</div>
    </div>
    
    <div class="service">
        <h2>üé£ Webhook Service (Port 3002)</h2>
        <p>Demonstrates HMAC signature verification</p>
        <div class="endpoint">GET /webhook/demo/signature - Documentation</div>
        <div class="endpoint">POST /webhook - Receive webhook (requires signature)</div>
        <div class="endpoint">POST /webhook-insecure - Receive webhook (no verification)</div>
    </div>
    
    <div class="service">
        <h2>üîê OAuth2 Server (Port 3003)</h2>
        <p>Demonstrates PKCE OAuth2 flow</p>
        <div class="endpoint">GET /auth/demo/pkce - PKCE flow documentation</div>
        <div class="endpoint">GET /auth/.well-known/openid_configuration - OIDC config</div>
        <div class="endpoint">GET /auth/auth - Authorization endpoint</div>
        <div class="endpoint">POST /auth/token - Token endpoint</div>
    </div>
    
    <p><strong>Direct Service Access:</strong></p>
    <ul>
        <li><a href="http://localhost:3001/demo/idempotency">Payment Service Demo</a></li>
        <li><a href="http://localhost:3002/demo/signature">Webhook Service Demo</a></li>
        <li><a href="http://localhost:3003/demo/pkce">OAuth2 Service Demo</a></li>
    </ul>
</body>
</html>';
            add_header Content-Type text/html;
        }
    }
}
